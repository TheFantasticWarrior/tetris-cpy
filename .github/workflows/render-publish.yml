name: Upload Package with render

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  setup_linux:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          sudo apt-get install libsdl2-dev
          export CFLAGS="-I/usr/include/SDL2" 
          export LDFLAGS="-L/usr/lib" 

  setup_windows:
    runs-on: windows-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'
      - name: Download SDL2 for Windows
        run: |
          mkdir SDL2
          curl -L https://www.libsdl.org/release/SDL2-devel-2.0.14-VC.zip -o SDL2/SDL2.zip
          Expand-Archive -Path SDL2/SDL2.zip -DestinationPath SDL2
          echo "::add-path::$(Get-Location)\SDL2\lib"
          echo "::add-path::$(Get-Location)\SDL2\include"

  setup_macos:
    runs-on: macos-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'
      - name: Install SDL2 on macOS
        run: |
          brew update
          brew install sdl2

  build_and_publish:
    needs: [setup_linux, setup_windows, setup_macos]
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'
      - name: Install build package
        run: |
          python -m pip install --upgrade pip
          pip install build
      - name: Build package
        run: |
          cd render
          python -m build
          cp -r dist ..
      - name: Publish package
        uses: pypa/gh-action-pypi-publish@27b31702a0e7fc50959f5ad993c78deac1bdfc29
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}

